#!/bin/bash
DIALOG=${DIALOG=dialog}
TMP_FILE=/tmp/gentoo-setup.$$.tmp
TITLE="Alex's Linux Configurator"

# End setup if [ESCAPE] is pressed
exit_on_esc () {
  if (( $1 == 255 )); then
    echo "quitting setup"
    exit 
  fi
}

# Check if a package is installed
install_check () {
  if [[ $(equery -q l $1) =~ . ]]; then 
    echo "1"
  fi
}

# Check that the script is running as superuser since we need
# permission to edit files in /etc and /usr.
if [ "$EUID" -ne 0 ]; then 
  $DIALOG --backtitle "$TITLE" \
          --title "Superuser not detected" \
          --msgbox "\nPlease run as root." 7 50 
  exit
fi

# Check to see if Gentoo is the OS so we can configure make.conf if so.
# This may be automated in the future.
$DIALOG --backtitle "$TITLE" \
        --title "Distro check" \
        --yesno "\nIs this a Gentoo install?" 7 50
is_gentoo=$?
exit_on_esc $is_gentoo

# If the OS is Gentoo then we try to detect the CPU and see if this 
# script supports it.
if (( $is_gentoo == 0 )); then
  while [ -z "$cpu_type" ]; do
    if [[ $(cat /proc/cpuinfo) == *"T2300"* ]]; then
      cpu_type="T2300"
    elif [[ $(cat /proc/cpuinfo) == *"i7-2600K"* ]]; then
      cpu_type="i7-2600K"
    else
      cpu_type="Your CPU is not supported. Please write your own make.conf"
    fi
  done
fi

if [[ $(install_check nano) ]]; then
  echo "success"
  else
  echo "failure"
fi

echo $is_gentoo
echo $cpu_type
